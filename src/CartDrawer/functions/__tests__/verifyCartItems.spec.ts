import { IVerifyCartItemsResponse, verifyCartItems } from "../verifyCartItems";

const cartState = {
  note: "",
  attributes: {},
  original_total_price: 3400,
  total_price: 3400,
  total_discount: 0,
  total_weight: 726.2014,
  item_count: 5,
  items: [
    {
      id: 50087333527865,
      properties: {},
      quantity: 1,
      variant_id: 50087333527865,
      key: "50087333527865:599619830c4a3a7be0db55c69ca5bbdd",
      title: "Sugar Cookie - 1 lbs / Fresh Ground",
      price: 3400,
      original_price: 3400,
      discounted_price: 3400,
      line_price: 3400,
      original_line_price: 3400,
      total_discount: 0,
      discounts: [],
      sku: "",
      grams: 454,
      vendor: "Long Run Coffee",
      taxable: true,
      product_id: 9689508577593,
      product_has_only_default_variant: false,
      gift_card: false,
      final_price: 3400,
      final_line_price: 3400,
      url: "/products/santa-sleighin-miles?variant=50087333527865",
      featured_image: {
        aspect_ratio: 1,
        alt: "Sugar Cookie",
        height: 4000,
        url: "//longruncoffee.com/cdn/shop/files/2_966617a6-aa1a-4d4e-86d8-666ace740e86.png?v=1730673574",
        width: 4000,
      },
      image:
        "//longruncoffee.com/cdn/shop/files/2_966617a6-aa1a-4d4e-86d8-666ace740e86.png?v=1730673574",
      handle: "santa-sleighin-miles",
      requires_shipping: true,
      product_type: "Flavored",
      product_title: "Sugar Cookie",
      product_description:
        "Asked Santa for a new PR this holiday season? Santa Always Delivers.\nSleighin' Miles is Long Run's newest Sugar Cookie flavored electrolyte infused coffee. \nIt is the perfect pre-run fuel for tough snowy miles or winter weight lifting. Electrolytes are great for recovery too - so pour a cup, curl up next to the fireplace, and recover fully from all your training.\nTreat yourself to performance and flavor this holiday season.",
      variant_title: "1 lbs / Fresh Ground",
      variant_options: ["1 lbs", "Fresh Ground"],
      options_with_values: [
        {
          name: "Size",
          value: "1 lbs",
        },
        {
          name: "Form",
          value: "Fresh Ground",
        },
      ],
      line_level_discount_allocations: [],
      line_level_total_discount: 0,
    },
    {
      id: 48056421482809,
      properties: {},
      quantity: 1,
      variant_id: 48056421482809,
      key: "48056421482809:338dfa3677dac86c7a02b20430fff0b0",
      title: "Long Run Brand Sticker",
      price: 0,
      original_price: 0,
      discounted_price: 0,
      line_price: 0,
      original_line_price: 0,
      total_discount: 0,
      discounts: [],
      sku: null,
      grams: 0,
      vendor: "Long Run Coffee",
      taxable: true,
      product_id: 9082015514937,
      product_has_only_default_variant: true,
      gift_card: false,
      final_price: 0,
      final_line_price: 0,
      url: "/products/free-gift-lrc-brand-sticker?variant=48056421482809",
      featured_image: {
        aspect_ratio: 1,
        alt: "Long Run Brand Sticker",
        height: 5000,
        url: "//longruncoffee.com/cdn/shop/files/LRCSticker_33.png?v=1707440763",
        width: 5000,
      },
      image:
        "//longruncoffee.com/cdn/shop/files/LRCSticker_33.png?v=1707440763",
      handle: "free-gift-lrc-brand-sticker",
      requires_shipping: true,
      product_type: "Gift",
      product_title: "Long Run Brand Sticker",
      product_description:
        " Designed to inspire and motivate, our brand is a reminder of your identity as an athlete. \nFuel Your Passion, and slap this sticker on mugs, water bottles, laptops, and more.\n\nDurable, High Quality Vinyl Sticker\n\nWater Proof and Dishwasher Safe\n",
      variant_title: null,
      variant_options: ["Default Title"],
      options_with_values: [
        {
          name: "Title",
          value: "Default Title",
        },
      ],
      line_level_discount_allocations: [],
      line_level_total_discount: 0,
    },
    {
      id: 49364569588025,
      properties: {},
      quantity: 1,
      variant_id: 49364569588025,
      key: "49364569588025:92185e3e2e1c54967fa57bf795511ac6",
      title: "Free LRC x BOCO Run Hat",
      price: 0,
      original_price: 0,
      discounted_price: 0,
      line_price: 0,
      original_line_price: 0,
      total_discount: 0,
      discounts: [],
      sku: "",
      grams: 91,
      vendor: "Long Run Coffee",
      taxable: true,
      product_id: 9464803852601,
      product_has_only_default_variant: true,
      gift_card: false,
      final_price: 0,
      final_line_price: 0,
      url: "/products/free-lrc-x-boco-run-hat?variant=49364569588025",
      featured_image: {
        aspect_ratio: 1,
        alt: "Free LRC x BOCO Run Hat",
        height: 5000,
        url: "//longruncoffee.com/cdn/shop/files/1_6046bc15-7204-4fae-8f45-e73a333e0543.png?v=1707394954",
        width: 5000,
      },
      image:
        "//longruncoffee.com/cdn/shop/files/1_6046bc15-7204-4fae-8f45-e73a333e0543.png?v=1707394954",
      handle: "free-lrc-x-boco-run-hat",
      requires_shipping: true,
      product_type: "Gift",
      product_title: "Free LRC x BOCO Run Hat",
      product_description:
        "Elevate your run with our breathable run hat collaboration with BOCO. Stay cool and motivated every mile with this runner's staple, designed to Fuel Your Passion.\n\nLightweight wicking polyester\nMachine Washable\n\n",
      variant_title: null,
      variant_options: ["Default Title"],
      options_with_values: [
        {
          name: "Title",
          value: "Default Title",
        },
      ],
      line_level_discount_allocations: [],
      line_level_total_discount: 0,
    },
    {
      id: 49568854671673,
      properties: {},
      quantity: 1,
      variant_id: 49568854671673,
      key: "49568854671673:b3bf13760593ec64a3b7fe705ebcc1c6",
      title: "Experimental Flavor - Trail Mix",
      price: 0,
      original_price: 0,
      discounted_price: 0,
      line_price: 0,
      original_line_price: 0,
      total_discount: 0,
      discounts: [],
      sku: "",
      grams: 45,
      vendor: "Long Run Coffee",
      taxable: true,
      product_id: 9516401033529,
      product_has_only_default_variant: true,
      gift_card: false,
      final_price: 0,
      final_line_price: 0,
      url: "/products/experimental-flavor-trail-mix-1?variant=49568854671673",
      featured_image: {
        aspect_ratio: 1,
        alt: "Experimental Flavor - Trail Mix",
        height: 2000,
        url: "//longruncoffee.com/cdn/shop/files/Long_Run_Coffee_Experimental.png?v=1732477244",
        width: 2000,
      },
      image:
        "//longruncoffee.com/cdn/shop/files/Long_Run_Coffee_Experimental.png?v=1732477244",
      handle: "experimental-flavor-trail-mix-1",
      requires_shipping: true,
      product_type: "Gift",
      product_title: "Experimental Flavor - Trail Mix",
      product_description:
        "Every club member shipment includes two free experimental electrolyte infused coffee samples. Club members get to test new roasts & flavors, and decide what LRC's next products will be.\nEach experimental flavor pack will brew one full pot of coffee. \n",
      variant_title: null,
      variant_options: ["Default Title"],
      options_with_values: [
        {
          name: "Title",
          value: "Default Title",
        },
      ],
      line_level_discount_allocations: [],
      line_level_total_discount: 0,
    },
    {
      id: 49182276747577,
      properties: {},
      quantity: 1,
      variant_id: 49182276747577,
      key: "49182276747577:0a3f56dfbc1a11e50b8268e21bf3d830",
      title: "Free Travel Set",
      price: 0,
      original_price: 0,
      discounted_price: 0,
      line_price: 0,
      original_line_price: 0,
      total_discount: 0,
      discounts: [],
      sku: "",
      grams: 136,
      vendor: "Long Run Coffee",
      taxable: true,
      product_id: 9416531542329,
      product_has_only_default_variant: true,
      gift_card: false,
      final_price: 0,
      final_line_price: 0,
      url: "/products/free-travel-set?variant=49182276747577",
      featured_image: {
        aspect_ratio: 1,
        alt: "Free Travel Set",
        height: 2000,
        url: "//longruncoffee.com/cdn/shop/files/Travel_Set_-_Junk_Miles_and_Banana.png?v=1727046479",
        width: 2000,
      },
      image:
        "//longruncoffee.com/cdn/shop/files/Travel_Set_-_Junk_Miles_and_Banana.png?v=1727046479",
      handle: "free-travel-set",
      requires_shipping: true,
      product_type: "Gift",
      product_title: "Free Travel Set",
      product_description:
        "The travel set includes sample bags of two of our best selling electrolyte infused coffees:\n\nA 4oz bag of our Junk Miles classic medium roast\nA 1.5oz sample of our athlete favorite Post Race Banana (banana bread flavor)\n\n",
      variant_title: null,
      variant_options: ["Default Title"],
      options_with_values: [
        {
          name: "Title",
          value: "Default Title",
        },
      ],
      line_level_discount_allocations: [],
      line_level_total_discount: 0,
    },
  ],
  requires_shipping: true,
  currency: "USD",
  items_subtotal_price: 3400,
  cart_level_discount_applications: [],
  checkout_charge_amount: 3400,
};

const totalSubscriptionItems = 0;

const cartSubTotal = 3400;

const cartRewardQuery = {
  status: "success",
  isLoading: false,
  isSuccess: true,
  isError: false,
  isIdle: false,
  data: [
    {
      id: 5,
      name: "Free Travel Set",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Site_Photos_1.png?v=1730674490",
      reward_type: "MONETARY",
      reward_threshold: 1,
      perks: ["Free Travel Packs"],
      add_to_cart_display_only: [],
      add_to_cart: [
        {
          id: "01932d70-7e8e-729e-a12e-459d469bf342",
          handle: "free-travel-set",
          variant_id: "gid://shopify/ProductVariant/49182276747577",
        },
        {
          id: "01934112-f01d-72b6-889f-b5981a18a2f0",
          handle: "free-gift-lrc-brand-sticker",
          variant_id: "gid://shopify/ProductVariant/48056421482809",
        },
      ],
    },
    {
      id: 2,
      name: "Base Subscription",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Long_Run_Coffee_Experimental_2_pack.png?v=1732477244",
      reward_type: "SUBSCRIPTION",
      reward_threshold: 2,
      perks: ["10% savings", "Experimental samples", "Free shipping"],
      add_to_cart_display_only: [],
      add_to_cart: [
        {
          id: "01932d72-5a2c-75df-8021-235049b1d14e",
          handle: "experimental-flavor-3",
          variant_id: "gid://shopify/ProductVariant/48137979953465",
        },
        {
          id: "01932d72-88cc-728e-a11e-b09e054d64fa",
          handle: "experimental-flavor-4",
          variant_id: "gid://shopify/ProductVariant/48138029531449",
        },
      ],
    },
    {
      id: 3,
      name: "Pro Subscription",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/YETI_1_9c2db956-c907-4043-b62c-b890a9c76f67.png?v=1725736631",
      reward_type: "SUBSCRIPTION",
      reward_threshold: 3,
      perks: [
        "20% savings",
        "Free experimentals",
        "Free Yeti Tumbler on your 3rd shipment",
      ],
      add_to_cart_display_only: [
        {
          id: "01932d72-f0ad-743d-872f-f0a66de2f5f4",
          image:
            "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/YETI_1_9c2db956-c907-4043-b62c-b890a9c76f67.png?v=1725736631",
          title: "Club Exclusive - LRC x YETI Tumbler",
          description: "In 3rd Shipment",
        },
      ],
      add_to_cart: [],
    },
    {
      id: 4,
      name: "Elite Subscription",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Club_Hat_be96f498-170e-4af6-bc4f-b047f584ad4c.png?v=1725736939",
      reward_type: "SUBSCRIPTION",
      reward_threshold: 4,
      perks: [
        "25% savings",
        "Free experimentals",
        "Free BOCO hat on your 3rd shipment",
      ],
      add_to_cart_display_only: [
        {
          id: "01932d74-d2ef-70b4-9648-1fe4e2d7dfc3",
          image:
            "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Club_Hat_be96f498-170e-4af6-bc4f-b047f584ad4c.png?v=1725736939",
          title: "Club Exclusive - LRC x BOCO Run Hat",
          description: "In 3rd Shipment",
        },
      ],
      add_to_cart: [],
    },
    {
      id: 1,
      name: "Free Shipping",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/free-shipping.png?v=1729286857",
      reward_type: "MONETARY",
      reward_threshold: 5900,
      perks: ["Free expedited shipping on your entire order"],
      add_to_cart_display_only: [],
      add_to_cart: [],
    },
    {
      id: 8,
      name: "Free Test Flavor - Pecan Brownie",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Long_Run_Coffee_Experimental.png?v=1732477244",
      reward_type: "MONETARY",
      reward_threshold: 9900,
      perks: [
        "Free Experimental Flavor Sample",
        " Pecan Brownie Flavor | Electrolyte Infused",
        " Brews One Full Pot of Coffee",
      ],
      add_to_cart_display_only: [],
      add_to_cart: [
        {
          id: "01932d82-5346-723e-8797-745fb4c150c3",
          handle: "experimental-flavor-pecan-brownie",
          variant_id: "gid://shopify/ProductVariant/50168179589433",
        },
      ],
    },
    {
      id: 9,
      name: "Free Flavor Packs: Trail Mix + Hazelnut",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Long_Run_Coffee_Experimental_2_pack.png?v=1732477244",
      reward_type: "MONETARY",
      reward_threshold: 10900,
      perks: [
        "Two Free Experimental Flavors",
        "Electrolyte Infused Coffee for Athletes",
        "Each Pack Brews One Full Pot of Coffee",
      ],
      add_to_cart_display_only: [],
      add_to_cart: [
        {
          id: "01932d71-8e65-77be-9fa5-7035f7dc311f",
          handle: "chestnut-praline-christmas-blend-dark-roast",
          variant_id: "gid://shopify/ProductVariant/50168190599481",
        },
      ],
    },
    {
      id: 10,
      name: "Free Hazelnut Latte Powder | Ready to Run",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Adam_Gif.gif?v=1728772600",
      reward_type: "MONETARY",
      reward_threshold: 14900,
      perks: [
        "Free Electrolytes + Caffeine Powder Mix",
        " Enjoy Hot or Cold: Hazelnut Latte Flavor",
        " Dissolves Fast",
      ],
      add_to_cart_display_only: [],
      add_to_cart: [
        {
          id: "019345af-ed20-7587-a5b8-ce207f495fbe",
          handle: "ready-to-run-electrolyte-caffeine-powder-mix",
          variant_id: "gid://shopify/ProductVariant/50007065166137",
        },
      ],
    },
    {
      id: 6,
      name: "Free $25 Gift Card",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/HeroImagesNoBG_1.png?v=1705764926",
      reward_type: "MONETARY",
      reward_threshold: 19900,
      perks: [
        "Free $25 Gift Card",
        "Electronically Delivered via Email after Checkout",
      ],
      add_to_cart_display_only: [],
      add_to_cart: [
        {
          id: "01932d71-e3fd-760c-a078-5b95b5181c07",
          handle: "free-25-gift-card",
          variant_id: "gid://shopify/ProductVariant/50119844954425",
        },
      ],
    },
    {
      id: 7,
      name: "Free Long Run x HydroFlask Bottle",
      image:
        "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/8_6d553d5c-31b8-468c-b8fe-19b74ad57e31.png?v=1719881674",
      reward_type: "MONETARY",
      reward_threshold: 24900,
      perks: [
        "Durable stainless steel",
        "Stores 16oz of liquid",
        "Cup holder compatible",
        "Leakproof",
        "Dishwasher safe",
      ],
      add_to_cart_display_only: [],
      add_to_cart: [
        {
          id: "01932d72-1cd7-77c6-bf46-5a0dcc4031e9",
          handle: "free-hydroflask",
          variant_id: "gid://shopify/ProductVariant/50115779363129",
        },
      ],
    },
  ],
  dataUpdatedAt: 1733795823892,
  error: null,
  errorUpdatedAt: 0,
  failureCount: 0,
  errorUpdateCount: 0,
  isFetched: true,
  isFetchedAfterMount: true,
  isFetching: false,
  isRefetching: false,
  isLoadingError: false,
  isPlaceholderData: false,
  isPreviousData: false,
  isRefetchError: false,
  isStale: true,
};

describe("verifyCartItems", () => {
  test("returns missing data if rewards query is not supplied", () => {
    const response = verifyCartItems({
      // @ts-ignore
      cartState,
      cartSubTotal,
      totalSubscriptionItems,
      // @ts-ignore
      cartRewardQuery: {
        ...cartRewardQuery,
        // @ts-ignore
        data: null,
      },
    });
    expect(response).toBe(IVerifyCartItemsResponse.MISSING_DATA);
  });
  test("happy path", () => {
    const response = verifyCartItems({
      // @ts-ignore
      cartState,
      cartSubTotal,
      totalSubscriptionItems,
      // @ts-ignore
      cartRewardQuery,
    });
    expect(response).toBe(IVerifyCartItemsResponse.VALID);
  });
  test("found missing item in cart", () => {
    const response = verifyCartItems({
      // @ts-ignore
      cartState: {
        note: "",
        attributes: {},
        original_total_price: 3400,
        total_price: 3400,
        total_discount: 0,
        total_weight: 726.2014,
        item_count: 5,
        items: [
          // @ts-ignore
          {
            id: 50087333527865,
            quantity: 1,
            variant_id: 50087333527865,
            title: "Sugar Cookie - 1 lbs / Fresh Ground",
            price: 3400,
          },
        ],
        requires_shipping: true,
        currency: "USD",
        items_subtotal_price: 3400,
        cart_level_discount_applications: [],
        checkout_charge_amount: 3400,
      },
      cartSubTotal,
      totalSubscriptionItems,
      // @ts-ignore
      cartRewardQuery: {
        status: "success",
        isLoading: false,
        isSuccess: true,
        isError: false,
        isIdle: false,
        data: [
          // @ts-ignore
          {
            id: 5,
            name: "Free Travel Set",
            image:
              "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Site_Photos_1.png?v=1730674490",
            reward_type: "MONETARY",
            reward_threshold: 1,
            perks: ["Free Travel Packs"],
            add_to_cart_display_only: [],
            add_to_cart: [
              {
                id: "01932d70-7e8e-729e-a12e-459d469bf342",
                handle: "free-travel-set",
                variant_id: "gid://shopify/ProductVariant/49182276747577",
              },
              {
                id: "01934112-f01d-72b6-889f-b5981a18a2f0",
                handle: "free-gift-lrc-brand-sticker",
                variant_id: "gid://shopify/ProductVariant/48056421482809",
              },
            ],
          },
        ],
        dataUpdatedAt: 1733795823892,
        error: null,
        errorUpdatedAt: 0,
        failureCount: 0,
        errorUpdateCount: 0,
        isFetched: true,
        isFetchedAfterMount: true,
        isFetching: false,
        isRefetching: false,
        isLoadingError: false,
        isPlaceholderData: false,
        isPreviousData: false,
        isRefetchError: false,
        isStale: true,
      },
    });
    expect(response).toBe(IVerifyCartItemsResponse.MISSING_CART_ITEMS);
  });
  test("found missing item in cart", () => {
    const response = verifyCartItems({
      // @ts-ignore
      cartState: {
        note: "",
        attributes: {},
        original_total_price: 3400,
        total_price: 3400,
        total_discount: 0,
        total_weight: 726.2014,
        item_count: 5,
        items: [
          // @ts-ignore
          {
            id: 49182276747577,
            quantity: 1,
            variant_id: 49182276747577,
            title: "I shouldn't be here",
            price: 3400,
          },
        ],
        requires_shipping: true,
        currency: "USD",
        items_subtotal_price: 3400,
        cart_level_discount_applications: [],
        checkout_charge_amount: 3400,
      },
      cartSubTotal,
      totalSubscriptionItems,
      // @ts-ignore
      cartRewardQuery: {
        status: "success",
        isLoading: false,
        isSuccess: true,
        isError: false,
        isIdle: false,
        data: [
          // @ts-ignore
          {
            id: 5,
            name: "Free Travel Set",
            image:
              "https://cdn.shopify.com/s/files/1/0761/6924/9081/files/Site_Photos_1.png?v=1730674490",
            reward_type: "MONETARY",
            reward_threshold: 10000000,
            perks: ["Free Travel Packs"],
            add_to_cart_display_only: [],
            add_to_cart: [
              {
                id: "01932d70-7e8e-729e-a12e-459d469bf342",
                handle: "free-travel-set",
                variant_id: "gid://shopify/ProductVariant/49182276747577",
              },
            ],
          },
        ],
        dataUpdatedAt: 1733795823892,
        error: null,
        errorUpdatedAt: 0,
        failureCount: 0,
        errorUpdateCount: 0,
        isFetched: true,
        isFetchedAfterMount: true,
        isFetching: false,
        isRefetching: false,
        isLoadingError: false,
        isPlaceholderData: false,
        isPreviousData: false,
        isRefetchError: false,
        isStale: true,
      },
    });
    expect(response).toBe(IVerifyCartItemsResponse.TOO_MANY_CART_ITEMS);
  });
});
